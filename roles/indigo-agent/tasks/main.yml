---
##############################################################################
# Create the virtualenv where we will host the indigo-agent app
##############################################################################
- name: update apt-cache
  apt: update_cache=yes
  sudo: yes

- name: Install python-dev
  apt: pkg=python-dev state=installed update_cache=no
  sudo: yes

- name: Manually create the agent virtualenv
  command: virtualenv "{{ install_dir }}/agent" creates="{{ install_dir }}/agent"

- name: Clone git repo
#  git: repo="/home/alloy/tmp/indigo_git/indigo-agent.git"
  git: repo="git@bitbucket.org:archivea/indigo-agent.git"
       dest="{{ install_dir }}/agent/project"
       key_file="{{ install_dir }}/.ssh/indigo_deployment_private_key"
       accept_hostkey=yes
       force=yes

- name: Install indigo agent into venv
  shell: "{{ install_dir }}/agent/bin/python setup.py develop"
  args:
    chdir: "{{ install_dir }}/agent/project"

- name: Install indigo lib into agent
  shell: "{{ install_dir }}/agent/bin/python setup.py develop"
  args:
    chdir: "{{ install_dir }}/indigo"

- name: "Copy init script"
  template: src=indigo-agent.conf dest=/etc/init/indigo-agent.conf
  sudo: yes
