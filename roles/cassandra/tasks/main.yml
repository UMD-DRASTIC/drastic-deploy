---
##############################################################################
# Java
# This must be Oracle's Java, and also should use libjna for performance.
##############################################################################
- name: Installation dependencies
  apt: pkg=python-apt state=installed update_cache=yes force=yes
  sudo: yes

- name: Add PPA for Oracle Java 8
  apt_repository: repo='ppa:webupd8team/java' state=present
  sudo: yes

- name: Select and agree to licence
  debconf: name='oracle-java8-installer' question='shared/accepted-oracle-license-v1-1' value='true' vtype='select'
  sudo: yes

- name: System dependencies
  sudo: yes
  apt: pkg={{ item }} state=installed update_cache=yes force=yes
  with_items:
    - python-apt
    - oracle-java8-installer
    - libjna-java
    - python-pip
    - git
    - curl
    # For client machine ...
    - libev4
    - libev-dev
    - build-essential
    - python-dev

##############################################################################
# Cassandra
##############################################################################

- name: Add Cassandra Repo
  shell: echo "deb http://debian.datastax.com/community stable main" | sudo tee -a /etc/apt/sources.list.d/cassandra.sources.list
  sudo: yes

- name: Cassandra repository key
  shell: curl -L http://debian.datastax.com/debian/repo_key | sudo apt-key add -
  sudo: yes

- name: Install cassandra
  apt: pkg=dsc22 state=installed update_cache=yes force=yes
  sudo: yes


##############################################################################
# Cassandra Cluster Manager
# Installs CCM for building a local (single-machine) cluster for development
# and testing
##############################################################################

- name: CCM Python Requirements
  pip: name={{item}}
  with_items:
    - PyYAML
    - cql
  sudo: yes
  when: production

- name: Download CCM
  git: repo=https://github.com/pcmanus/ccm.git dest='{{ temp_dir }}/ccm'
  when: production

- name: Install CCM
  shell: ./setup.py install
  sudo: yes
  args:
    chdir: '{{ temp_dir }}/ccm'
  when: production

##############################################################################
# Cassandra Configuration
# Installs the configuration files for this Cassandra cluster
##############################################################################

# This will restart Cassandra only if the configuration file has changed. See handlers/main.yaml
- name: Copy Cassandra configuration file
  template: src=cassandra.yaml dest=/etc/cassandra/cassandra.yaml
  notify:
    - Restart Cassandra
  sudo: yes

#- name: "Copy Cassandra Topology"
#  copy: src=templates/cassandra-topology.properties dest=/etc/cassandra/cassandra-topology.properties
#  sudo: true

- name: Start Cassandra
  service: name=cassandra state=running
  sudo: yes

- name: Waiting for Cassandra to finish initialization
  action: command cqlsh -e exit
  register: cqlsh_ready
  until: cqlsh_ready.rc == 0
  delay: 5
