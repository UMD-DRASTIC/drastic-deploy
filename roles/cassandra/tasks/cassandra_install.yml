- name: Install Cassandra Python driver and CQLSH tool
  pip: name=cassandra-driver

- name: Add Cassandra APT Repository
  apt_repository: repo="deb http://www.apache.org/dist/cassandra/debian 311x main" state=present
  become: yes

- name: Add Cassandra APT Key
  apt_key: url=https://www.apache.org/dist/cassandra/KEYS state=present
  become: yes

- name: Install Cassandra package
  apt: package=cassandra update_cache=yes allow_unauthenticated=yes
  become: yes

# This will restart Cassandra only if the configuration file has changed. See handlers/main.yaml
- name: Copy Cassandra configuration file
  template: src=cassandra.yaml dest=/etc/cassandra/cassandra.yaml
  notify:
    - Restart Cassandra
  become: yes

- name: Create Cassandra cache directory
  file: path=/var/lib/cassandra/saved_caches state=directory mode=0775 owner=cassandra group=cassandra
  become: yes

- name: Create Cassandra commitlog directory
  file: path=/var/lib/cassandra/commitlog state=directory mode=0770 owner=cassandra group=cassandra
  become: yes
  notify: Restart Cassandra

- name: Set OS user limits
  become: yes
  blockinfile:
    dest: /etc/security/limits.conf
    insertafter: EOF
    block: |
      * - memlock unlimited
      * - nofile 100000
      * - nproc 32768
      * - as unlimited
